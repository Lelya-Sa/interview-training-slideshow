# CircleCI Configuration for Node.js/React Application
# Location: .circleci/config.yml

version: 2.1

# Reusable commands
commands:
  install_dependencies:
    description: "Install npm dependencies"
    steps:
      - run:
          name: Install dependencies
          command: npm ci
  
  run_tests:
    description: "Run tests with coverage"
    steps:
      - run:
          name: Run tests
          command: npm test
      - run:
          name: Generate coverage
          command: npm run test:coverage
      - store_artifacts:
          path: coverage
          destination: coverage

# Reusable jobs
jobs:
  # Job: Lint and test
  test:
    docker:
      - image: cimg/node:18.0
    steps:
      - checkout
      - install_dependencies
      - run:
          name: Run linter
          command: npm run lint
      - run_tests
      - store_test_results:
          path: test-results

  # Job: Build application
  build:
    docker:
      - image: cimg/node:18.0
    steps:
      - checkout
      - install_dependencies
      - run:
          name: Build application
          command: npm run build
          environment:
            NODE_ENV: production
      - persist_to_workspace:
          root: .
          paths:
            - build

  # Job: Build Docker image
  build_docker:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - setup_remote_docker:
          version: 20.10.14
      - attach_workspace:
          at: .
      - run:
          name: Build Docker image
          command: |
            docker build -t $CIRCLE_PROJECT_REPONAME:$CIRCLE_SHA1 -t $CIRCLE_PROJECT_REPONAME:latest .
      - run:
          name: Push Docker image
          command: |
            echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
            docker push $CIRCLE_PROJECT_REPONAME:$CIRCLE_SHA1
            docker push $CIRCLE_PROJECT_REPONAME:latest

  # Job: Deploy to staging
  deploy_staging:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - run:
          name: Deploy to staging
          command: |
            echo "Deploying to staging..."
            # Add deployment commands

# Workflow definition
workflows:
  version: 2
  test_and_deploy:
    jobs:
      # Run tests on all branches
      - test:
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /.*/
      
      # Build and deploy only on main branch
      - build:
          requires:
            - test
          filters:
            branches:
              only: main
      
      - build_docker:
          requires:
            - build
          filters:
            branches:
              only: main
      
      - deploy_staging:
          requires:
            - build_docker
          filters:
            branches:
              only: main
