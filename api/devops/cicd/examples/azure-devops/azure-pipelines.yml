# Azure DevOps Pipeline for Node.js/React Application
# Location: azure-pipelines.yml

trigger:
  branches:
    include:
      - main
      - master
  paths:
    exclude:
      - README.md
      - docs/*

pr:
  branches:
    include:
      - main
      - master

# Pool of agents to run jobs
pool:
  vmImage: 'ubuntu-latest'

# Variables
variables:
  nodeVersion: '18.x'
  dockerRegistryServiceConnection: 'DockerRegistry'
  imageRepository: 'myapp'
  containerRegistry: 'yourregistry.azurecr.io'
  dockerfilePath: '$(Build.SourcesDirectory)/Dockerfile'
  tag: '$(Build.BuildId)'

# Stages
stages:
  # Stage 1: Build and Test
  - stage: Build
    displayName: 'Build and Test'
    jobs:
      - job: Test
        displayName: 'Run Tests'
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '$(nodeVersion)'
            displayName: 'Install Node.js'
          
          - script: |
              npm ci
            displayName: 'Install dependencies'
          
          - script: |
              npm run lint
            displayName: 'Run linter'
            continueOnError: true
          
          - script: |
              npm test
            displayName: 'Run tests'
          
          - script: |
              npm run test:coverage
            displayName: 'Generate coverage'
          
          - task: PublishTestResults@2
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: 'test-results/**/*.xml'
            displayName: 'Publish test results'
          
          - task: PublishCodeCoverageResults@1
            inputs:
              codeCoverageTool: 'Cobertura'
              summaryFileLocation: '$(System.DefaultWorkingDirectory)/coverage/cobertura-coverage.xml'
            displayName: 'Publish coverage results'
      
      - job: Build
        displayName: 'Build Application'
        dependsOn: Test
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '$(nodeVersion)'
          
          - script: |
              npm ci
            displayName: 'Install dependencies'
          
          - script: |
              npm run build
            displayName: 'Build application'
            env:
              NODE_ENV: production
          
          - task: PublishBuildArtifacts@1
            inputs:
              pathToPublish: '$(System.DefaultWorkingDirectory)/build'
              artifactName: 'build'
            displayName: 'Publish build artifacts'

  # Stage 2: Build Docker Image
  - stage: BuildDocker
    displayName: 'Build Docker Image'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - job: Docker
        displayName: 'Build and Push Docker Image'
        steps:
          - task: Docker@2
            inputs:
              command: buildAndPush
              repository: '$(imageRepository)'
              dockerfile: '$(dockerfilePath)'
              containerRegistry: '$(dockerRegistryServiceConnection)'
              tags: |
                $(tag)
                latest
            displayName: 'Build and push Docker image'

  # Stage 3: Deploy to Staging
  - stage: DeployStaging
    displayName: 'Deploy to Staging'
    dependsOn: BuildDocker
    condition: succeeded()
    jobs:
      - deployment: DeployStaging
        displayName: 'Deploy to Staging Environment'
        environment: 'staging'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: Bash@3
                  inputs:
                    targetType: 'inline'
                    script: |
                      echo "Deploying to staging environment..."
                      # Add deployment commands here
                      # Example: kubectl apply, helm upgrade, etc.
                  displayName: 'Deploy to staging'

  # Stage 4: Deploy to Production
  - stage: DeployProduction
    displayName: 'Deploy to Production'
    dependsOn: DeployStaging
    condition: succeeded()
    jobs:
      - deployment: DeployProduction
        displayName: 'Deploy to Production Environment'
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: ManualValidation@0
                  inputs:
                    notifyUsers: |
                      your-email@example.com
                    instructions: 'Please approve deployment to production'
                    onTimeout: 'reject'
                  displayName: 'Manual approval'
                
                - task: Bash@3
                  inputs:
                    targetType: 'inline'
                    script: |
                      echo "Deploying to production environment..."
                      # Add deployment commands here
                  displayName: 'Deploy to production'
